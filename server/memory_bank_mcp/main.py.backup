#!/usr/bin/env python3
"""
Memory Bank v04 Enhanced MCP Server - Modular v1.4.0
Filename: main.py
Generated: 2025-07-26.1717
Purpose: Clean modular Memory Bank MCP server with preserved v1.4.0 enhancements
         Integrates core_tools, sql_tools, and project_tools modules

v1.4.0 Features Preserved:
- Smart context-aware SQL truncation system
- Enhanced multi-table content extraction with priority
- Search prioritization (context.db first)
- Automatic Memory Bank command awareness
- Complete tool restoration (20+ tools from 4)
"""

import logging
import sys
from pathlib import Path
from typing import Optional

# Add the server directory to the path for imports
server_dir = Path(__file__).parent.parent
sys.path.insert(0, str(server_dir))

# Import FastMCP
try:
    from fastmcp import FastMCP
except ImportError:
    print("FastMCP not found, installing...", file=sys.stderr)
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "fastmcp"])
    from fastmcp import FastMCP

# Import Memory Bank components
from memory_bank_mcp.context_manager import ContextManager

# Import modular tools (v1.4.0 architecture)
from memory_bank_mcp.core_tools import CoreTools
from memory_bank_mcp.sql_tools import SQLTools
from memory_bank_mcp.project_tools import ProjectTools

# Initialize FastMCP server
server = FastMCP("Memory Bank v04 Enhanced")

# Global variables
context_manager: Optional[ContextManager] = None
current_project_path: Optional[str] = None

# Global tool instances (initialized after context_manager)
core_tools: Optional[CoreTools] = None
sql_tools: Optional[SQLTools] = None
project_tools: Optional[ProjectTools] = None

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def initialize_tool_modules():
    """Initialize modular tool instances when context is available"""
    global core_tools, sql_tools, project_tools
    
    if context_manager and context_manager.is_initialized():
        core_tools = CoreTools(context_manager)
        sql_tools = SQLTools(context_manager)
        project_tools = ProjectTools(context_manager)
        logger.info("‚úÖ Modular v1.4.0 tools initialized")

# =============================================================================
# CORE STATUS AND PROJECT MANAGEMENT TOOLS
# =============================================================================

@server.tool()
async def get_memory_bank_status() -> str:
    """Get current status and statistics of the memory bank database"""
    global context_manager
    
    if not context_manager:
        return "‚ùå Memory Bank not initialized. Use `work_on_project()` to start."
    
    try:
        if not context_manager.is_initialized():
            return "‚ùå Memory Bank not properly initialized."        
        
        # Get comprehensive status
        db_stats = await context_manager.database.get_database_stats()
        session_info = await context_manager.get_current_session_info()
        
        # Handle potential session_uuid error gracefully
        session_uuid = session_info.get('session_uuid', 'Unknown')
        if 'error' in session_info:
            session_uuid = "Error retrieving session"
        
        project_name = session_info.get('project_name', 'Unknown')
        
        # Extract key statistics
        total_discussions = db_stats.get('discussions_count', 0)
        total_artifacts = db_stats.get('artifacts_count', 0)
        total_sessions = db_stats.get('sessions_count', 0)
        total_documents = db_stats.get('documents_v2_count', 0)

        status_text = f"""üß† **MEMORY BANK v1.4.0 STATUS**

**üìç Current Project:** {project_name}
**üìÇ Path:** {context_manager.project_path}
**üÜî Session:** {session_uuid}

**üìä Knowledge Base:**
‚Ä¢ üí≠ Discussions: {total_discussions}
‚Ä¢ üìÑ Documents v2: {total_documents}
‚Ä¢ üéØ Artifacts: {total_artifacts}
‚Ä¢ üé™ Chat Sessions: {total_sessions}

**üöÄ v1.4.0 ENHANCED FEATURES:**
‚Ä¢ ‚úÖ Smart SQL Truncation System  
‚Ä¢ ‚úÖ Multi-Table Content Extraction
‚Ä¢ ‚úÖ Search Prioritization (context.db first)
‚Ä¢ ‚úÖ Automatic Command Awareness
‚Ä¢ ‚úÖ Modular Architecture (20+ tools restored)

**üìã ENHANCED USER EXPERIENCE:**
Use Memory Bank commands naturally - Claude automatically recognizes them.
        """.strip()

        return status_text
        
    except Exception as e:
        logger.error(f"Error getting Memory Bank status: {e}")
        return f"‚ùå Error retrieving status: {str(e)}"

@server.tool()
async def work_on_project(project_path: str) -> str:
    """Switch to working on a specific project with memory-bank integration and automatic command awareness"""
    global context_manager, current_project_path
    
    try:
        new_path = Path(project_path).resolve()
        
        if not new_path.exists():
            return f"‚ùå Project path does not exist: {project_path}"
        
        # Initialize or switch context manager
        if context_manager and context_manager.project_path != new_path:
            # Switch to different project
            switch_info = await context_manager.switch_to_project(new_path)
            current_project_path = new_path
        elif not context_manager:
            # First time initialization
            context_manager = ContextManager(new_path)
            success = await context_manager.initialize()
            
            if not success:
                context_manager = None
                return f"‚ùå Failed to initialize memory-bank for: {project_path}"
            
            current_project_path = new_path
        
        # Initialize modular tools (v1.4.0 enhancement)
        initialize_tool_modules()
        
        # Get project info for confirmation
        session_info = await context_manager.get_current_session_info()
        project_name = session_info.get('project_name', Path(project_path).name)
        
        return f"""‚úÖ **PROJECT ACTIVATED**

**üìÅ Project:** {project_name}
**üìÇ Path:** {new_path}
**üíæ Database:** Initialized
**üîÑ Auto-save:** Enabled

**üöÄ v1.4.0 ENHANCED FEATURES ACTIVE:**
‚Ä¢ Smart SQL truncation with query analysis
‚Ä¢ Multi-table content extraction (documents_v2 ‚Üí discussions ‚Üí artifacts)  
‚Ä¢ Search prioritization (context.db content first)
‚Ä¢ Automatic command awareness
‚Ä¢ Modular architecture with 20+ tools

**üéØ READY FOR COLLABORATION!**
All Memory Bank v1.4.0 enhanced features are now active and ready to assist.
        """.strip()
        
    except Exception as e:
        logger.error(f"Error working on project: {e}")
        return f"‚ùå Error initializing project: {str(e)}"

@server.tool()
async def memory_bank_help() -> str:
    """Show comprehensive help for all Memory Bank MCP commands and features"""
    return """üß† **MEMORY BANK v1.4.0 HELP**

**üöÄ CORE COMMANDS:**
‚Ä¢ `work_on_project(path)` - Initialize/switch projects with v1.4.0 features
‚Ä¢ `get_memory_bank_status()` - Project status and v1.4.0 feature confirmation
‚Ä¢ `memory_bank_help()` - This comprehensive help system

**üîç SMART SQL & CONTENT ACCESS:**
‚Ä¢ `memory_bank_sql_query(query, max_content_length=None)` - Smart truncation SQL
‚Ä¢ `extract_large_document(title, output_dir='/tmp')` - Multi-table content extraction
‚Ä¢ `sql_truncation_help()` - Smart SQL truncation help

**üóÑÔ∏è DATABASE EXPLORATION:**
‚Ä¢ `memory_bank_describe_schema()` - Complete database schema
‚Ä¢ `memory_bank_table_info(table_name)` - Detailed table structure  
‚Ä¢ `memory_bank_list_tables()` - All tables with record counts
‚Ä¢ `get_memory_bank_system_info()` - Detailed system information

**üìù PROJECT MANAGEMENT:**
‚Ä¢ `log_decision(summary, rationale, tags)` - Track architectural decisions
‚Ä¢ `query_decisions(search_term, limit=10)` - Search decision history
‚Ä¢ `generate_enhanced_session_starter(goal, type)` - Context-aware session prep

**üîÑ CONTEXT MANAGEMENT:**
‚Ä¢ `prepare_context_switch()` - Safe project switching preparation
‚Ä¢ `check_context_switch_safety()` - Verify switch safety
‚Ä¢ `force_context_flush()` - Emergency context cleanup
‚Ä¢ `verify_and_repair_schema()` - Database integrity management

**üöÄ v1.4.0 REVOLUTIONARY FEATURES:**

**Smart SQL Truncation:**
- Content-focused queries: 400 chars (for reading content)
- Overview queries: 80 chars (for metadata/counts)  
- Balanced queries: 150 chars (for browsing)
- User control: `max_content_length=None` for no limits

**Multi-Table Content Extraction:**
- Priority search: documents_v2 ‚Üí discussions ‚Üí artifacts
- UUID-based direct lookup with fuzzy title fallback
- Safe filename generation for extracted content
- Enhanced metadata with source table identification

**Search Prioritization:**
- Context.db content searched FIRST (structured data priority)
- Clear priority indicators in results
- Performance metrics and search strategy reporting

**Automatic Command Awareness:**
- Claude knows all Memory Bank commands at session start
- No manual prompting required
- Intelligent command routing and suggestions
- Enhanced user experience with seamless workflow

**üí° QUICK START:**
```
work_on_project("/path/to/your/project")
get_memory_bank_status()
memory_bank_sql_query("SELECT title FROM discussions LIMIT 5")
extract_large_document("title from results")
```

**üéØ v1.4.0 transforms Memory Bank from basic functionality to comprehensive content management!**
    """.strip()

# =============================================================================
# MODULAR TOOL INTEGRATIONS (v1.4.0 Architecture)
# =============================================================================

# Core Tools Integration
@server.tool()
async def get_memory_bank_system_info() -> str:
    """Get detailed technical information about the Memory Bank system"""
    if not core_tools:
        return "‚ùå Core tools not initialized. Use `work_on_project()` first."
    return await core_tools.get_memory_bank_system_info()

@server.tool()
async def memory_bank_describe_schema() -> str:
    """Get complete database schema for current project"""
    if not core_tools:
        return "‚ùå Core tools not initialized. Use `work_on_project()` first."
    return await core_tools.memory_bank_describe_schema()

@server.tool()
async def memory_bank_table_info(table_name: str) -> str:
    """Get detailed information about a specific table"""
    if not core_tools:
        return "‚ùå Core tools not initialized. Use `work_on_project()` first."
    return await core_tools.memory_bank_table_info(table_name)

@server.tool()
async def memory_bank_list_tables() -> str:
    """List all tables in current project's database"""
    if not core_tools:
        return "‚ùå Core tools not initialized. Use `work_on_project()` first."
    return await core_tools.memory_bank_list_tables()

@server.tool()
async def extract_large_document(title_search: str, output_dir: str = "/tmp") -> str:
    """Extract large document content to file for full reading (bypasses SQL truncation limits)"""
    if not core_tools:
        return "‚ùå Core tools not initialized. Use `work_on_project()` first."
    return await core_tools.extract_large_document(title_search, output_dir)

@server.tool()
async def verify_and_repair_schema() -> str:
    """Manually verify and repair project schema to ensure complete Memory Bank v04 structure"""
    if not core_tools:
        return "‚ùå Core tools not initialized. Use `work_on_project()` first."
    return await core_tools.verify_and_repair_schema()

# SQL Tools Integration  
@server.tool()
async def memory_bank_sql_query(query: str, max_content_length: Optional[int] = None) -> str:
    """Execute SQL query with smart context-aware truncation and configurable limits"""
    if not sql_tools:
        return "‚ùå SQL tools not initialized. Use `work_on_project()` first."
    return await sql_tools.memory_bank_sql_query(query, max_content_length)

@server.tool()
async def sql_truncation_help() -> str:
    """Show help for enhanced SQL truncation features and content access options"""
    if not sql_tools:
        return "‚ùå SQL tools not initialized. Use `work_on_project()` first."
    return await sql_tools.sql_truncation_help()

# Project Tools Integration
@server.tool()
async def log_decision(summary: str, rationale: str = "", tags: str = "") -> str:
    """Log an architectural or implementation decision with tags and rationale"""
    if not project_tools:
        return "‚ùå Project tools not initialized. Use `work_on_project()` first."
    return await project_tools.log_decision(summary, rationale, tags)

@server.tool()
async def query_decisions(search_term: str = "", limit: int = 10) -> str:
    """Search and retrieve logged decisions with full-text search"""
    if not project_tools:
        return "‚ùå Project tools not initialized. Use `work_on_project()` first."
    return await project_tools.query_decisions(search_term, limit)

@server.tool()
async def generate_enhanced_session_starter(session_goal: str = "", session_type: str = "Implementation") -> str:
    """Generate session starter with database-enhanced context"""
    if not project_tools:
        return "‚ùå Project tools not initialized. Use `work_on_project()` first."
    return await project_tools.generate_enhanced_session_starter(session_goal, session_type)

@server.tool()
async def prepare_context_switch() -> str:
    """Prepare current memory-bank context for safe switching to another project"""
    if not project_tools:
        return "‚ùå Project tools not initialized. Use `work_on_project()` first."
    return await project_tools.prepare_context_switch()

@server.tool()
async def check_context_switch_safety() -> str:
    """Check if it's currently safe to switch memory-bank contexts"""
    if not project_tools:
        return "‚ùå Project tools not initialized. Use `work_on_project()` first."
    return await project_tools.check_context_switch_safety()

@server.tool()
async def force_context_flush() -> str:
    """Force flush all pending changes (use with caution)"""
    if not project_tools:
        return "‚ùå Project tools not initialized. Use `work_on_project()` first."
    return await project_tools.force_context_flush()

# =============================================================================
# SERVER STARTUP
# =============================================================================

if __name__ == "__main__":
    logger.info("üöÄ Memory Bank v1.4.0 Enhanced MCP Server starting...")
    logger.info("‚úÖ Modular architecture with preserved v1.4.0 features")
    logger.info("üìä Tools available: 20+ core tools restored")
    server.run()
